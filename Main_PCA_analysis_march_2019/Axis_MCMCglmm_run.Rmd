---
title: "Axis_analysis_18_feb_2019"
author: "Kevin Healy"
date: "18 feb 2019"
output:
  html_document: default
  pdf_document: default
---

Lets source our packages etc.
```{r source functions}

library(popbio)
library(popdemo)
library(ape)
library(caper)
library(phytools)
library(MCMCglmm)
library(mulTree)
library(ineq)
library(pspline)
library(paran)

#devtools to get the Mage package
library(devtools)
source("Demography_functions.R")
```

You should have calulated all the population matrics and created a dataset to uplaod for the analysis here. 

```{r  data}

pop_data <- read.csv("axis_analysis_data_4_march_2019.csv", 
                         sep = ",", header = T)

```

```{r  how many have multiple pops}
unq_sp <- unique(pop_data$species)

pop_length <- data.frame(matrix(0, nrow = length(unq_sp), ncol = c(2)))
for(i in 1:length(unq_sp)){

pop_length[i,1] <- as.character(pop_data[pop_data$species == as.character(unq_sp[i]),2])[1]

pop_length[i,2] <- as.numeric(as.vector(length(pop_data[pop_data$species == as.character(unq_sp[i]),1])))

}

```

We will also have porduced a bunch of phylogentic trees with some error in order to conduct our analysis.

```{r phylogeny}

axis_trees <- read.tree("axis_analysis_phylo.tre")
##remove this for the main run
#axis_trees <- axis_trees[1:3]

#small fix on ultrametric problem
is_ultra <- vector()
for(i in 1:100) { 
  is_ultra[i] <- is.ultrametric(axis_trees[[i]])
  }

ultra_row <- which(is_ultra ==TRUE)

axis_trees <- axis_trees[ultra_row]

plot(axis_trees[[1]], cex = 0.2, type = "fan")


##this will be when its a multiphy object
#plot(com_tree[[sample(seq(1:(length(com_tree))),1)]], cex = 0.2)
```

Lets also caluculate mean life expectancy divided by max life expectancy
```{r mean e/max e }

life_shape <-  pop_data$mean_life_expect/pop_data$surv_95

pop_data$life_shape <- life_shape
```




Log10 the non index based metrics
```{r log data }

log_list <- c("life_time_La",
              "mean_repo_rate_stable_state",
              "mean_repo_rate",
              "gen_time",
              "M_rep_lif_exp",
              "mass_g",
              "matrix_size")

pop_data_log <- pop_data

pop_data_log[,log_list] <- sapply(pop_data[,log_list], function(x) log10(x))

```

Now let mean center all the data

```{r mean center data }
mean_c_list  <- c("life_shape", 
                  "life_time_La", 
                  "mean_repo_rate",
                  "gen_time",
                  "M_rep_lif_exp",
                  "matrix_size",
                  "gini",
                  "mean_repo_rate_stable_state",
                  "mxlxsd",
                  "surv_sd",
                  "mass_g")

pop_data_log_mc <- pop_data_log
pop_data_log_mc[,mean_c_list] <- sapply(pop_data_log[,mean_c_list], function(x) mean_center(x))

```


Lets do a quick panal plot
```{r panel plot}
pairs(pop_data_log_mc[,c("life_shape", 
                  "life_time_La",
                  "mean_repo_rate_stable_state",
                  "mean_repo_rate",
                  "gen_time",
                  "gini",
                  "M_rep_lif_exp",
                  "matrix_size",
                  "mass_g")])

```




First we make a multree object so we can loop each of the models through the trees
```{r mulTree}
pop_multree <- as.mulTree(data = pop_data_log_mc, tree = axis_trees, taxa = "animal", rand.terms = ~animal + species)

```

Now lets set a prior
```{r MCMC prior}

prior<-list(R = list(V = 1/2, nu=0.002), 
            G = list(G1=list(V = 1/2,n = 1, alpha.mu=rep(0,1), alpha.V= diag(1)*10^3), 
                     G1=list(V = 1/2,n = 1, alpha.mu=rep(0,1), alpha.V= diag(1)*10^3)))

```

and general parameters
```{r MCMC parameters}

parameters <- c(1100000, 500, 100000)

```


survial shape metric

```{r survial shape metric allometries mulTree run}
formula_life_shape <- life_shape ~ mass_g + matrix_size

#mulTree(mulTree.data = pop_multree,
#        formula = formula_life_shape,
#        priors = prior,
#        parameters = parameters,
#        output = "life_shape_run",
#        ESS = 1000,
#        chains = 2)
```


age at first reproduction

```{r La allometries mulTree run}
formula_la <- life_time_La ~ mass_g + matrix_size

#mulTree(mulTree.data = pop_multree,
#        formula = formula_la,
#        priors = prior,
#        parameters = parameters,
#        output = "la_run",
#        ESS = 1000,
#        chains = 2)
```


Lets run it for mean reproductive rate with the population at a stable state distribution.


```{r mean_repo_rate allometries mulTree run}
formula_mean_repo_rate <- mean_repo_rate_stable_state ~ mass_g + matrix_size

#mulTree(mulTree.data = pop_multree,
#        formula = formula_mean_repo_rate,
#        priors = prior,
#        parameters = parameters,
#        output = "mean_repo_rate_run",
#        ESS = 1000,
#        chains = 2)
```


```{r mean_repo_rate_st allometries mulTree run}
formula_mean_repo_rate_nst <- mean_repo_rate ~ mass_g + matrix_size

#mulTree(mulTree.data = pop_multree,
#        formula = formula_mean_repo_rate_nst,
#        priors = prior,
#        parameters = parameters,
#        output = "mean_repo_rate_nst_run",
#        ESS = 1000,
#        chains = 2)
```


standard deviation of mxlx


```{r mxlxsd allometries mulTree run}
formula_mxlxsd <- mxlxsd ~ mass_g + matrix_size

#mulTree(mulTree.data = pop_multree,
#        formula = formula_mxlxsd,
#        priors = prior,
#        parameters = parameters,
#        output = "mxlxsd_logged_run",
#        ESS = 1000,
#        chains = 2)
```


Lets run it for generation time


```{r gen allometries mulTree run}
formula_gen_time <- gen_time ~ mass_g + matrix_size

#mulTree(mulTree.data = pop_multree,
#        formula = formula_gen_time,
#        priors = prior,
#        parameters = parameters,
#        output = "gen_time_run",
#        ESS = 1000,
#        chains = 2)
```


Lets run it for life expectancy conditional on reaching sexual maturity


```{r M_rep_lif_exp allometries mulTree run}
formula_M_rep_lif_exp <- M_rep_lif_exp ~ mass_g + matrix_size

#mulTree(mulTree.data = pop_multree,
#        formula = formula_M_rep_lif_exp,
#        priors = prior,
#        parameters = parameters,
#        output = "M_rep_lif_exp_run",
#        ESS = 1000,
#        chains = 2)
```


Lets run it for the gini index


```{r gini allometries mulTree run}
formula_gini <- gini ~ mass_g + matrix_size

#mulTree(mulTree.data = pop_multree,
#        formula = formula_gini,
#        priors = prior,
#        parameters = parameters,
#        output = "gini_run",
#        ESS = 1000,
#        chains = 2)
```




Lets run it for the standard deviation of mortality rates

```{r surv_sd allometries mulTree run}
formula_surv_sd <- surv_sd ~ mass_g + matrix_size

#mulTree(mulTree.data = pop_multree,
        formula = formula_surv_sd,
        priors = prior,
        parameters = parameters,
        output = "surv_sd_run",
        ESS = 1000,
        chains = 2)
```


